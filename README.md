# mimosa-ai

## Quickstart
若要執行 Server , 可以下列指令執行
### 自動執行(建議使用)
點擊 `run.bat` 或是進入 terminal 執行以下指令  
```bash
cd workspace_path
run.bat [prod|dev]
```
預設該檔案將會執行 `prod`
正式機將以此方式進行環境部屬  
### 手動執行
```bash
cd workspace_path
conda activate py_cal
python server.py [-bl] [-ml] [-md dev]
```
* bl: 啟動但不於啟動當下執行一次批次  
* ml: 不啟動 Server
* md: 執行環境參數 預設為 dev  
  
### Note
* 當系統初始啟動時, 會偵測資料夾下是否存在 `_local` 資料夾, 若不存在則會啟動初始化  
* 初始化時, 會執行復原的動作, 這是假設系統經過意外崩潰重新建立後的狀況  
* 執行復原時, 若資料庫中存在現象資料, 但不存在市場資料時, 這時候會對系統中的模型進行 **偽訓練**  
   > 在**偽訓練**的情況下, 並不會真正於 python server 中建立模型, 但仍會在資料庫中標記建立完成  
* 訓練模型時所使用的市場, 若是存在一筆以上的市場時, 採用**烙印當前全市場**進行訓練, 並**永久保存**  
   > **烙印**意思為記憶住當下所使用的市場清單, 即使未來市場數量有變動, 也不會進行變更
* 若不存在任何市場, 則採用 **偽訓練** 的方式, 舉例來說:  
* 當初始化資料庫時, 資料表中沒有任何資料, 接著將部分現象與模型資訊導入後觸發系統初始化, 此時由於系統中不存在任何市場資料, 因此會使用**偽訓練**建立模型  
這時, 若有人於資料庫中新增**一個市場**, 並觸發批次, 這時候系統就會使用**這一個市場**進行所有模型的建立, 並於未來每日都使用該模型進行預測  
因此即使未來增加了 1000 個市場, 這些初始化時建立的模型也只會用當初建立時所使用的**一個市場**進行所有市場的預測  
* 系統執行時的紀錄檔將會存放於 `workspace_path/log` 資料夾底下  
* 系統執行時會於 `workspace_path/../_local` 底下建立本地端快取檔案  

## Overview
這個專案主要提供 Mimosa 的主網站後台運算服務, 其中包含
 - Python 每日計算每個現象對於每個市場的發生與否
 - Python 每日計算每個現象每個市場的未來各天期報酬的各個統計資訊: 包含 總現象發生次數, 未發生次數, 現象發生後上漲次數, 現象發生後持平次數, 現象發生後下跌次數
 - Python 啟動後的前次執行狀態還原機制, 當 Python Server 意外中斷並重啟後需還原前次最後執行狀態, 並將其重啟並完成
 - Python Server 的各項功能, 包含: 新增觀點, 刪除觀點
 - 取得歷史現象發生時間點
 - 取得歷史複合現象發生時間點
 - 取得複合現象在指定市場類別下的各市場發生次數
 - 取得複合現象在指定市場類別下的各天期上漲機率
 - 取得複合現象在指定市場類別, 產業別下發生後的各天期報酬統計資訊

## Installation
安裝的方法需搭配 [Miniconda](https://docs.conda.io/en/latest/miniconda.html) 進行安裝  
Mimoconda 安裝完成後, 使用以下指令建立 Pyhton 環境  
### 自動安裝(建議使用)
點擊 `install.bat` 或是進入 terminal 執行以下指令  
```bash
cd workspace_path
install.bat
```
這樣的安裝方式會在當前工作資料夾下建立 conda 環境  
正式機將以此方式進行環境部屬  
### 手動安裝
```bash
cd workspace_path
conda env create --file requirements.yml
```
預設建立的環境名稱為`py_cal`, 若有需要則可以更改  
這樣的安裝方式會在使用者的 conda 環境下建立環境

## Development
這部分開始為提供給這個專案的開發者, 以下將會提出需要注意的各項專案規範與檔案結構  
### Working directory
本專案的檔案結構如下
```bash
.
├─func
│　├─_td
│　└─_tp
├─const.py
├─dao.py
├─model.py
├─server.py
└─utils.py
```
以下將針對各個系統功能進行檔案的分工說明  
#### func
本專案的運算核心函式，內部包含 `_td` 與 `_tp` 兩個資料夾，用以提供系統中所有現象的計算  
##### _td
現象計算時的各項資料結構，用以提供穩定且快速的時間序列計算  
##### _tp
現象中使用的 `Macro` 存放地點，將對應到資料表中的 `func` 欄位，當有需要新增 Macro 時，需在此建立對應的方法  
#### const
系統中各項常數定義，舉凡 Table schema, 本地快取存放的資料夾路徑等皆會在此進行定義  
#### dao
系統中的各項資料存取，只要涉及到存取資料表或是本地端資料的功能都會在這個檔案中進行實作  
#### model
系統中觀點的執行檔案，用以實作各項觀點的運作函式，包含：新增、更新、跑批、初始化等方法  
#### server
系統中對外的各項服務，這個檔案將會定義對外開放的 API Path 與各項關於 server 運作的實作  
#### utils
系統中將會使用到的各個通用函式，例如: pickle 檔案的讀寫, 記憶體快取機制等  
### Git 規範
關於這份 git 的各項規範, 在這邊進行描述  
#### Branch 的規範
本規範沿用 Softbi Java team 的規範, 目前主要分支有:  

 - `master` : 正式環境上的版本分支
 - `develop` : 用於開發的基礎分支
 - `feature` : 新功能開發的分支
 - `hotfix` : 正式環境 Bug 處理的分支
  
`master` 分支用於發佈在正式機上，所有異動都只能由 `develop` 分支合併到這個分支上。目前正式機已套用自動上版, 因此在該 branch 節點更新的同時就會觸發上版流程, 所以 **請勿自行將分支整合進`master`中**, 若有需求請洽詢專門負責該部分的同仁  
`develop` 分支是用於開發的基礎分支，所有分支皆由此分支建立。當完成測試且確認異動正式環境，即將此分支合併至主線 `master`。  
`feature` 分支為新功能開發之分支，由分支 `develop` 所建立，當完成測試且確認異動正式環境，即將此分支合併至分支 `develop`。分支格式為: `feature/YYYYMMDD-topic`, 其中 `YYYYMMDD` 為創建分支日期, `topic` 為上版日期或簡稱(可不填)  
`hotfix` 分支為正式環境 Bug 處理之分支，由分支 `develop` 所建立，當完成測試且確認異動正式環境，即將此分支合併至分支 `develop`。分支格式為: `hotfix/YYYYMMDD-topic`, 其中 `YYYYMMDD` 為創建分支日期, `topic` 為上版日期或簡稱(可不填)  

#### Pull 時的規範
為了讓分支不會因為共同開發而變得凌亂, 於 `pull` 時使用以下指令以避免分支分岔的情況
```git
git pull --rebase
```

#### Commit message 的規範
 > 這邊的 `commit message` 規範僅作為撰寫時使用的**參考**, 實際上僅需撰寫 `Header` 與 `Body` 的部分, 並遵守 `type` 的使用場景即可。**請不要因為規範過於複雜而不上 `commit`**  

```markdown
Header: <type>(<scope>): <subject>
- type: 代表commit的類別：feat, fix, docs, style, refactor, test, chore，必要欄位。
- scope: 代表commit影響的範圍，例如資料庫、控制層、模板層等等，視專案不同而
不同，為可選欄位。
- subject: 代表此commit的簡短描述，不超過50個字元，結尾不加句號，為必要欄
位。

Body: 72-character wrapped. This should answer:
- Body部分是對本次Commit的詳細描述，可以分成多行，每一行不超過72字元。
- 說明程式碼變動的項目與原因，還有與先前行為的對比。

Footer:
- 填寫任務編號（如果有的話）。
- BREAKING CHANGE（可忽略），紀錄不兼容的變動，
  以 BREAKING CHANGE: 開頭，後面是對變動的描述，以及變動原因和遷移方法。

```
 * type:subject 是簡述，不超過50字元。
 * 標題與內文間需空一行，內文與註腳間也需空一行。
 * 內文當遇到全半形單字切換時，需將半形字以兩個空格分隔，例如：「新增一個
 feature進資料庫」，需改為「新增一個 feature 進資料庫」。
 * 內文當遇到需要使用列表或清單條列項目時，需要在編號與條列內文間以一個空格
 區隔，例如：「1.條列項目」需要改成「1. 條列項目」。
 
#### Type
用來告訴進行 Code Review 的人應該以什麼態度來檢視 Commit 內容。  
例如：  
* 看到Type為`fix`，進行Code Review的人就可以用「觀察Commit如何解決錯誤」的角度來閱讀程式碼。  
* 看到Type為`refactor`，進行Code Review的人可以放輕鬆閱讀程式碼是如何被重構，因為重構的本質是不會影響既有的功能。  

利用不同Type來決定進行Code Review檢視的角度，可以提升Code Review的速度，因此開發團隊應該對這些Type的使用時機有一致的認同。  
只允許使用以下類別：
 * `feat`：新增/修改功能（feature）。
 * `fix`：修補bug（bug fix）。
 * `docs`：文件（documentation）。
 * `style`：格式（不影響程式碼運行的變動white-space, formatting, missing semi colons, etc）。
 * `refactor`：重構（既不是新增功能，也不是修補bug的變動）。
 * `perf`：改善效能（A code change that improves performance）。
 * `test`：增加測試（when adding missing tests）。
 * `chore`：建構程序或輔助工具的變動（maintain）。
 * `revert`：撤銷回復先前的commit，例如：revert: type(scope): subject(回復版本：xxxx)。  

以下將進行各項型別的詳細描述

---
##### feat
```git
feat: 

需求描述：

因應新需求做調整：

調整項目：

```
內文應包含下列三項
 * 需求描述
針對本次新增的需求進行描述，主要是對於 Title 無法完整描述需求時的輔助說明。若 Title 已經能夠完整描述需求，則可以與 Title 相同。需求描述能夠以短述或是條列進行說明，無硬性規定。
 * 因應新需求做調整
需將新需求如何調整進行條列式描述
 * 調整項目

對調整的檔案進行條列式描述：格式為
編號. 調整的檔案，調整內容
調整內容若需要以列表呈現時，則使用以下方式呈現（注意『 - 』的縮排）
 - 內容1
 - 內容2

**Example**
```bash
feat: message 信件通知功能

需求描述：
 - 通知和 message 都要寄發每日郵件，通知和 message 都放在同一封信裡面就好，
 不然信件太多可能也不會有人想去看。

因應新需求做調整：
1. 在每日信件任務中增加 message 部分。

調整項目：
1. mail_template.php，新增 message 區塊。
2. Send_today_notify_mail.php，新增/取得每日 Message 邏輯。
3. Message_model_api.php，新增 $where 參數，以便取得每日訊息。
4. Message_api.php 、 Message_group_user_model_api.php 、 新增 **取得訊息
使用者** 邏輯，以便撈取每日訊息。

issue #863

```

```bash
feat: 表單統計，多顯示計畫名稱欄位

需求描述：
在匯出、統計或取得查詢表單時，需要額外顯示訓練計畫名稱的欄位

因應新需求做調整：
1. 列表資訊多加「計畫名稱」欄位，以利後續匯出資料處理。

調整項目：
1. Assessment_form.php，匯出表單統計時，新增訓練計畫名欄位。
2. customize.php，表單統計查詢時，多顯示訓練計畫名欄位。
3. Complex_assessment_form_api.php、Complex_assessment_form_model_api：
- 取得表單統計資料時，多取得計畫名稱。

issue #863

```
---
##### fix
```bash
fix: 

問題： 

原因：

調整項目: 

```

內文應包含以下三項
 * 問題
以條列方式描述本次修正的問題為何
 * 原因
以條列的方式解釋造成本次修正問題的原因為何
 * 調整項目
以條列的方式描述修正了那些檔案，並且該檔修正了哪些部分

調整項目的條列滿足以下格式：
編號. 調整的檔案，調整內容
調整內容若需要以列表呈現時，則使用以下方式呈現（注意『 - 』的縮排）
-	內容1
-	內容2

**Example**
```bash
fix: 自訂表單新增/編輯畫面，修正離開葉面提醒邏輯

問題：
1. 原程式碼進入新增頁面後，沒做任何動作之下，離開頁面會跳提醒。
2. 原程式碼從新增/編輯頁面回到上一頁後（表單列表頁面），離開頁面會跳提\醒。

原因：
1. 新增頁面時，頁面自動建立空白題組會調用 sort_item，造成初始化 unload
   事件處理器。
2. 回到上衣頁後，就不需要監聽 unload 事件，應該把 unload 事件取消掉。

調整項目:
1. 初始化 unload 事件處理器：排除新增表單時，葉面自動建立空白題組調用
   sort_item 的情境。
2. 回到上一頁後，復原表單被異動狀態且清除 unload 事件處理器。

issue #1335

```

```bash
fix: 意見反應

問題：
1. 客戶反應：意見反應的信件都看不到圖片。

原因：
1. 目前程式碼都會要求先登入後才可查看使用者上傳的檔案，造成在信件上會看
   不見圖片的問題。

調整項目:
1. File.php，經討論後，開放讓意見反應頁面上傳的檔案，不用登入就可以查
   看/下載。

issue #1229

```
---
##### docs
```bash
docs: 新增註解/修正註解/移除過期的註解

[詳細內容]

```

Docs的Title中僅包含三項：新增註解、修正註解以及移除過期的註解
詳細內容則可以彈性填寫。

**Example**
```bash
docs: 新增註解
```

```bash
docs: 修正型別註解

讓 IDE 可以讀取到正確的類別
```

```bash
docs: 移除過期的註解

issue #1229
```
---
##### style
```bash
style: 

調整原因：

調整項目：

```

調整原因中描述為何對更動的區塊做撰寫風格調整。
調整項目中針對各調整檔案條列並進行描述。

**Example**

```bash
style: message 頁面，對 Component 做 Beautifier

調整原因：
經 IE 瀏覽器測試後發現 Component 裡面仍然夾帶 ES6 語法，
但是目前 Component 的程式碼都被壓縮成一行，
為了日後修改程式方便，故先對所有被壓縮的程式碼做 Beautifier

調整項目：
1. View_component.php：
- 針對所有被壓縮的程式碼做 Beautifier。
- 移除被註解的程式碼，原本被註解的程式碼應該是壓縮前的程式碼，
但是經測試後發現這些被註解的程式碼都是舊 Code，故移除。

```

---

##### refactor
```bash
refactor: 

需求描述：

因應需求做調整：

調整項目：

```

需求描述中描述為何進行重構。(移除過時程式碼也算)
因應需求做調整中描述如何進行重構以達成目標
調整項目中針對各調整檔案條列並進行描述。

**Example**
```bash
refactor: 重構取得「簽核流程種類名稱」邏輯

需求描述：
原程式碼取得流程名稱的邏輯散落在多個檔案，為了讓未來
新增/修改種類名稱時，不必到多個檔案中查找程式，需進行重構

因應效能需求做調整：
1. 統一透過 Process::get_type_name($process_type) 方法，
   取得流程種類名稱。

調整項目：
1. Process.php，新增 get_type_name() 方法，供取得流程名稱使用。
2. workflow_type_name.php，此 View 檔案只是為了取得流程名稱，現在以
   Process::get_type_name() 取代，故刪除。

```

---
##### perf
```bash
perf: 

需求描述：

因應效能需求做調整：

調整方式：

結果：

```

 - 因應效能需求做調整以條列方式進行描述
 - 調整方式以條列方式進行說明
 - 結果以條列方式進行描述，需描述改進部分與改進幅度。

**Example**
```bash
perf: 評核表單列表，優化取得受評者速度

需求描述：
原本取得受評者的邏輯會造成載入頁面緩慢（開發機約 52 秒），故作優化。

因應效能需求做調整：
1. 修改取得時的邏輯，縮短頁面載入時間。

調整方式：
1. 原程式碼每個表單迴圈進入 DB 取得受評者資料改成進 DB 一次撈取全部
   受評者資料，再回到 PHP 分配資料。

結果：
1. 開發機載入頁面時間 52 秒 => 5 秒

```

---
##### test
 - 動到測試，但是沒有動到功能的皆算在這個項目
 - 新增、修改、刪除、重構遺漏的測試項目

---
##### chore
系統使用的檔案更新皆使用本項目，例如：環境的組態設定更新、系統執行的批次等等

##### revert
待編輯

### Coding style
本規範參考來源為: https://legacy.gitbook.com/@python-guide
#### 編碼
- 除特殊狀況，一律採用 UTF-8 編碼，並於文件頭部加入
`#-*-coding:utf-8-*-`

#### 程式碼格式
##### 縮排
- 一律採用 **4** 個空白進行縮排

##### 行寬
- 每行程式碼建議不超過 80 字符，上限以 120 字符為限。

##### 字串
- 自然語言：使用雙引號
- 機器標示：使用單引號
- 正則表達式：使用原生雙引號
- 文檔字符串(docstring)：使用三個雙引號

##### 空行
- 模塊級函數與類定義之間要空兩行
- 類成員函數之間要空一行
- 可以使用多個空行區隔多組相關的函數
- 函數中可以使用空行分隔出邏輯相關的程式碼

##### Import 語句
- 應分行書寫
- 應使用 absolute import
- 應置於模塊說明及 docstring 之後，於全局變量之前
- 應按照字母順序排列，每組間以一個空行分隔
- 導入其它模塊的類定義時，可以使用相對導入
- 如果發生名稱衝突，可以使用命名空間

##### 空格
- 二元運算前後各要一個空格
- 函數的參數列表中，, 之後要有空格
- 函數的參數列表中，默認值等號兩邊都不要加空格
- 左括號後、右括號前都不要加空格
- 字典對象的左括號前面不要加空格
- 不要為了對齊而對賦值語句添加額外的空格

##### 換行
- 括號換行：
若於起始括號就換行，第二行以後一律縮排 **4** 個空格；反之，則縮排字括號的起始處
- 反斜槓換行：
二元運算符出現於行末；長字符串也可以使用此方法換行
- 禁止複合語句(一行中包含多個語句)
- `if` / `for` / `while` 一律要換行

#### 文檔與註釋
##### 程式碼註釋
###### 塊註釋
- `#` 號後要空一格
- 段落間用空行分隔

###### 行註釋
- 使用兩個(以上)空格與語句分開

###### 其他
- 不要使用沒有意義的注釋!!
- 在程式碼較複雜或關鍵的地方，要盡量寫注釋加以說明
- 比較重要的注釋段，可以使用多個等號隔開，彰顯其重要性

##### 文檔註釋
- 文檔注釋應位於其所在之模塊、函數和類別的頭部
- 以三個雙引號開頭和結尾，首行不換行，如有多行，末行需換行
- 不要在文檔中複製函數定義原型，而是具體描述其功能、參數與返回值
- 不限定中英文，但不要混用
- 模塊、公有類別、公有方法都要寫文檔注釋

#### 命名規範
##### 模塊
- 使用全小寫命名
- 除非多單詞，否則避免使用底線

##### 類別
- 使用駝峰式(CamelCase)命名風格
- 私有類以底線開頭

##### 函數
- 使用全小寫命名，如有多單詞，以底線分隔
- 私有函數以底線開頭

##### 變數
- 使用全小寫命名，如有多單詞，以底線分隔
- 私有變數以底線開頭

##### 常數
- 使用全大寫命名，如有多單詞，以底線分隔

##### 其他
- 除了計數器和迭代器，避免使用單字符名稱
- 避免使用小寫(L)、大寫(O、I) 單字符名稱
- 當名稱與 Python 保留字衝突時，應於名稱後加一個底線，而非使用縮寫或自創單字

#### 其他
- 避免裸程式碼：
盡量不要將程式碼寫在模塊的頂層中，在執行的主程序前要加入
`if __name__ == ‘__main__’` 避免模塊被導入時，主程序被執行
- 避免使用+號拼接字符串，應使用join方法或格式化字串
- 在不複雜的情況下，盡量使用列表生成式
- 盡量使用 map 和 filter 等內置函數，而不是自己寫循環
- 正則表達式使用前盡量先編譯好

## Copyright and Licenses
Code and documentation copyright 2022 Softbi, Inc.

