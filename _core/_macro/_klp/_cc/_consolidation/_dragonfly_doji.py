# -*- coding: utf-8 -*-
"""Common used by Macors in Dragonfly Doji's Series.

Created on Wed Aug 10 09:17:48 2022

@author: WaNiNi
"""

import numpy as np

from func._td import NumericTimeSeries, TimeUnit

from .._common import Candlestick, LeadingTrend, MacroInfo

LeadingTrends = LeadingTrend.type
_ENG_NAME = 'DragonFlyDoji'
_CHT_NAME = 'T字線'

description = (f"[{_CHT_NAME}({_ENG_NAME})]\n"
               "判定規則：\n"
               "1. 市場處於指定趨勢(詳見參數`近期趨勢`)；\n"
               "2. 實體線長度為零或接近於零。\n"
               "3. 不存在上影線或上影線長度接近於零。\n"
               "4. 存在長下影線。\n"
               "現象說明：\n"
               f"基本上，{_CHT_NAME}的發生，表示在該段時間內，一開始賣盤壓力大；"
               "驅使價格持續下跌，但後來買盤力量增強，將價格推回接近開盤價的位置。"
               f"在下降段出現{_CHT_NAME}，表示賣盤壓力可能正在減弱，有可能出現反轉；"
               f"在上升段出現{_CHT_NAME}，表示買盤力量已經開始減弱，"
               "未來上升趨勢有可能趨緩甚至出現反轉。"
               f"但，單獨的{_CHT_NAME}往往不能確定走勢是否會發生反轉，一般來說，"
               "還需要更多的訊號才能做進一步的確認。")

array = np.array

_DEFAULT_SAMPLES = {}
_DEFAULT_SAMPLES[LeadingTrends.NONE] = {
    TimeUnit.DAY:
        np.array([[100, 100, 95, 100]]).T,
    TimeUnit.WEEK:
        np.array([[100, 100, 90, 100]]).T,
    TimeUnit.MONTH:
        np.array([[100, 100, 80, 100]]).T}

_DEFAULT_SAMPLES[LeadingTrends.BULLISH] = {
    TimeUnit.DAY:
        array([[ 94.54390102,  96.02096828,  92.9417355 ,  96.02096828],
               [ 93.70881981,  96.07910096,  93.64204914,  93.74754742],
               [ 94.60149678,  97.22526779,  94.15712933,  95.87054664],
               [ 95.73593881,  98.77836462,  95.26762343,  98.38980864],
               [ 98.50901711, 100.40683449,  98.00304139,  99.37542269],
               [ 99.58041874,  99.96262541,  96.5912302 ,  97.64841277],
               [ 99.36698001, 103.12899768,  99.36698001, 103.12617434],
               [100.92773414, 102.34703019, 100.34668098, 101.16476277],
               [102.66158933, 106.22865483, 102.61104569, 106.22865483],
               [104.89176393, 107.91845447, 104.68561305, 107.91845447],
               [108.0765034 , 108.07766169, 106.18173324, 107.9362617 ]]).T,
    TimeUnit.WEEK:
        array([[ 89.25051465,  95.5862804 ,  89.25051465,  92.94350453],
               [ 92.47175407,  96.85622687,  92.07562644,  95.31897361],
               [ 94.74787329, 100.60721469,  93.79404979,  97.88499235],
               [100.17712746, 105.4021844 ,  98.69394985, 101.74320013],
               [105.25535972, 109.21728516,  99.88364442, 109.21728516],
               [111.31715728, 111.58198657, 105.45592808, 111.26736643]]).T,
    TimeUnit.MONTH:
        array([[ 81.54873906,  87.9803708 ,  77.63387536,  87.86160826],
               [ 87.0517301 , 105.79609112,  81.63932874, 104.54775214],
               [103.7844365 , 116.71648888, 101.7969603 , 115.16139639],
               [114.56581381, 114.56581381, 104.97999208, 114.36960267]]).T}

_DEFAULT_SAMPLES[LeadingTrends.BEARISH] = {
    TimeUnit.DAY:
        array([[105.90482969, 107.70574957, 105.03787571, 105.59437442],
               [105.56081618, 105.76042337, 103.29605731, 104.66848779],
               [103.21134349, 104.57708693, 100.88659467, 104.39578003],
               [104.63641152, 104.63641152, 102.45427259, 104.02850945],
               [103.84358289, 104.35863995, 102.50660382, 104.35863995],
               [101.98534515, 102.1515099 ,  99.60737827, 100.04804947],
               [100.47203007, 102.01311477,  99.84096862, 101.19265552],
               [ 99.96548787, 102.42228315,  98.39147845, 101.94483994],
               [ 97.47984426,  97.47984426,  94.05931943,  94.54382294],
               [ 93.78147085,  93.78147085,  89.82436752,  91.24326268],
               [ 88.17545343,  88.17545343,  85.93401152,  88.06404682]]).T,
    TimeUnit.WEEK:
        array([[105.65086597, 107.93954329, 102.30159911, 106.67897035],
               [103.22077327, 107.95392018, 100.36005304, 106.99441931],
               [106.06673506, 108.83887379, 102.12398971, 102.96523702],
               [104.14751169, 105.22303118,  94.40421122,  99.15798072],
               [ 97.46327826,  97.78092136,  87.83408991,  90.39168659],
               [ 91.5264344 ,  91.57292545,  87.83002366,  91.57292545]]).T,
    TimeUnit.MONTH:
        array([[118.7558332 , 118.7558332 , 104.43156853, 110.09053423],
               [109.93823657, 113.1233852 ,  95.39333255,  95.39333255],
               [ 98.51604355, 100.95216865,  92.27217836,  92.52877023],
               [ 90.7323865 ,  90.7323865 ,  78.08345547,  90.30055471]]).T}

_DEFAULT_SAMPLES[LeadingTrends.STRICTLY_BULLISH] = {
    TimeUnit.DAY:
        array([[ 91.57859812,  93.6784101 ,  90.96005516,  92.97231488],
               [ 93.37790129,  96.21231288,  92.70183691,  95.62314374],
               [ 96.76280002,  97.87804992,  95.14076773,  95.33600098],
               [ 93.41153239,  98.33974939,  93.12763724,  98.33974939],
               [ 96.62726931, 100.93150214,  96.38182718,  99.99636612],
               [101.18904618, 103.28195933, 100.02531651, 102.40972425],
               [100.12213103, 102.56133085,  98.96329427, 101.69337955],
               [102.34666403, 104.27015375, 101.0077461 , 103.23447119],
               [103.7065092 , 104.32766875, 100.79157477, 101.53103459],
               [102.7077178 , 107.27770481, 102.7077178 , 107.27770481],
               [110.27679296, 110.40467403, 108.25763485, 110.25022371]]).T,
    TimeUnit.WEEK:
        array([[ 84.65889238,  89.31727127,  84.03564681,  89.31727127],
               [ 88.32863625,  96.18015055,  87.65470013,  93.59149162],
               [ 95.60752394,  95.87562245,  90.55912936,  95.6394888 ],
               [ 96.77234034, 104.92879769,  96.77234034, 104.24417712],
               [102.38051201, 117.34473657, 102.25091086, 115.67766905],
               [119.16283509, 119.22593189, 111.40106254, 119.07286168]]).T,
    TimeUnit.MONTH:
        array([[ 89.3661929 ,  98.13890211,  85.50604391,  91.27342523],
               [ 92.84461616, 100.0843463 ,  91.77475179,  98.98149115],
               [100.47164131, 110.56439244,  97.50375414, 110.51230659],
               [110.64102282, 110.92690003, 101.15304575, 110.25716737]]).T}

_DEFAULT_SAMPLES[LeadingTrends.STRICTLY_BEARISH] = {
    TimeUnit.DAY:
        array([[106.3927353 , 112.21169062, 105.87207035, 110.45970571],
               [108.99758466, 111.10044365, 107.62129051, 110.49772733],
               [110.73353192, 111.28130065, 103.40258036, 103.40258036],
               [104.40811791, 106.24385134, 101.92974839, 102.73587932],
               [101.61941284, 103.51713156, 100.98491207, 103.45044963],
               [100.0137571 , 100.48922284,  98.19727407,  99.74910386],
               [ 98.6310997 ,  99.01482162,  94.75596993,  96.22970816],
               [ 94.43804473,  95.46633925,  94.17414714,  94.17414714],
               [ 97.2141026 ,  97.3293856 ,  92.58895177,  93.82713973],
               [ 92.34439497,  92.34439497,  90.23507282,  90.63615704],
               [ 90.96063428,  90.96521673,  88.49484821,  90.86332121]]).T,
    TimeUnit.WEEK:
        array([[109.81850683, 116.40775092, 108.10015726, 108.10015726],
               [104.07085225, 110.96930232, 104.07085225, 106.74100092],
               [106.1796343 , 111.12329   , 103.73943604, 105.89719377],
               [105.77282425, 105.77282425,  94.31956555,  95.29734917],
               [ 93.45222287,  94.21093056,  85.31506878,  86.57633088],
               [ 87.08562931,  87.08562931,  82.82049633,  87.07299461]]).T,
    TimeUnit.MONTH:
        array([[131.17285735, 131.7442727 , 106.08884004, 113.12783959],
               [111.57295451, 113.69980838,  97.01427141,  98.75277807],
               [ 97.75703771, 100.43858718,  83.76632418,  84.99338006],
               [ 84.66086672,  85.35176695,  76.04190464,  83.8165105 ]]).T}

def _func(cct: Candlestick) -> NumericTimeSeries:
    ret = (cct.is_doji_body &
           cct.is_without_uppershadow &
           cct.is_long_lowershadow)
    return ret

dragonfly_doji = MacroInfo(symbol=_ENG_NAME,
                           name=_CHT_NAME,
                           description=description,
                           func=_func,
                           interval=1,
                           samples=_DEFAULT_SAMPLES,
                           py_version="2201",
                           db_version="2201")
